# LOTA 远程升级工具



## 下发升级指令

业务系统可以根据需求决定哪些设备、哪些软件需要升级，OTA 指令数据包括：

- 将要升级的软件版本号
- 此次升级的类型（应用、固件、OS 等，由业务系统和设备约定）
- 升级包的下载地址（URL）
- 升级包的 md5 签名
- 升级包的大小（单位为字节）

注：不建议将升级包放在 MQTT 协议消息的 Payload 里面，而是将 URL 放入 Payload，设备端 Client 收到消息后再通过 URL 下载文件。



## 上报升级进度

当设备 Client 接收到升级指令后，应该按照次序执行以下操作：

1. 下载升级包

2. 校验安装包的 md5 签名

3. 执行安装或烧写

4. 上报升级进度，包括升级包下载进度、升级中发生的错误等（可选）

   ```json
   {
       type: "firmware",
       version: "1.1",
       progress: 70,
       desc: "downloading"
   }
   ```

5. 升级完成或重启后，上报新的软件版本

注：progress 记录升级包的下载/安装进度，取值为 0~100，同时也可作为错误码使用，-1 表示下载失败，-2 表示签名校验失败，-3 表示安装/烧写失败，-4 表示其他错误导致的升级失败。

由于在软件包安装过程中，设备应用可能处于不可控状态，所以确定安装升级包是否成功的依据只有一个：检查设备状态中的软件版本号是否更新为期望的版本号，而不能只依赖设备上报的进度数据。
